syntax = "proto3";
option cc_enable_arenas = true;

package YandexQuery;
option java_package = "com.yandex.query";
option java_outer_classname = "YandexQueryProtos";

import "kikimr/public/api/protos/validation/validation.proto";
import "kikimr/public/api/protos/ydb_operation.proto";
import "kikimr/public/api/protos/ydb_value.proto";
import "kikimr/public/api/protos/ydb_issue_message.proto";

import "google/protobuf/timestamp.proto";

////////////////////////////////////////////////////////////

// Operation API

message StringsPair {
    string key = 1 [(Ydb.length).le = 102400];
    string value = 2 [(Ydb.length).le = 102400];
}

message Acl {
    enum Visibility {
        VISIBILITY_UNSPECIFIED = 0;
        PRIVATE = 1; // by default
        FOLDER = 2;
    }
    
    Visibility visibility = 1;
}

message Limits {
    message StreamingLimits {
        int64 vcpu_rate_limit = 1 [(Ydb.value) = ">= 0"];
        int64 flow_rate_limit = 2 [(Ydb.value) = ">= 0"];
    }
    message AnalyticsLimits {
        int64 vcpu_time_limit = 1 [(Ydb.value) = ">= 0"];
        int64 max_result_size = 2 [(Ydb.value) = ">= 0"];
        int64 max_result_rows = 3 [(Ydb.value) = ">= 0"];
    }
    oneof limits {
        StreamingLimits streaming = 1;
        AnalyticsLimits analytics = 2;
    }
    int64 memory_limit = 3 [(Ydb.value) = ">= 0"];
}

enum ExecuteMode {
    EXECUTE_MODE_UNSPECIFIED = 0;
    PARSE = 1;
    COMPILE = 2;
    VALIDATE = 3;
    EXPLAIN = 4;
    RUN = 5;
    REPLACE_ALWAYS = 6;
    REPLACE_WITH_FRESH_STATE = 7;
    REPLACE_CHECK = 8;
}

enum OperationAction {
    OPERATION_ACTION_UNSPECIFIED = 0;
    PAUSE = 1;
    PAUSE_GRACEFULLY = 2;
    ABORT = 3;
    ABORT_GRACEFULLY = 4;
    RESUME = 5;
}

message Query {
    enum QueryType {
        QUERY_TYPE_UNSPECIFIED = 0;
        ANALYTICS = 1;
        STREAMING = 2;
    }

    string cloud_id = 1 [(Ydb.length).le = 1024];
    string folder_id = 2 [(Ydb.length).range = {min: 1, max: 1024}]; // folder_id or ABC
    QueryType type = 3; 
    string name = 4 [(Ydb.length).le = 1024];
    Acl acl = 5;
    Limits limits = 6;
    string content = 7 [(Ydb.length).range = {min: 1, max: 102400}];
    google.protobuf.Timestamp expiration_deadline = 8;
}

message CommonMeta {
    string id = 1 [(Ydb.length).range = {min: 1, max: 1024}];
    string created_by = 2 [(Ydb.length).range = {min: 1, max: 1024}];
    string modified_by = 3 [(Ydb.length).range = {min: 1, max: 1024}];
    google.protobuf.Timestamp created_at = 4;
    google.protobuf.Timestamp modified_at = 5;
    int64 revision = 6 [(Ydb.value) = ">= 0"];
}

message OperationMeta {
    enum ComputeState {
        COMPUTE_STATE_UNSPECIFIED = 0;
        STARTING = 1;
        ABORTED = 2;
        ABORTING = 3;
        RUNNING = 4;
        COMPLETED = 5;
        ERROR = 6;
        PAUSED = 7;
    }

    CommonMeta common = 1;
    google.protobuf.Timestamp started_at = 2;
    google.protobuf.Timestamp finished_at = 3;
    OperationAction action = 5;
    ExecuteMode mode = 6;
    ComputeState status = 7;
}

message OperationInfo {
    Query.QueryType type = 1; 
    string name = 2 [(Ydb.length).le = 1024];
    OperationMeta meta = 3;
}

message OperationEntry {
    OperationMeta meta = 1;
    Query query = 2;
}

message OperationStatistics {
    string yson = 1 [(Ydb.length).le = 102400];
}

message OperationResult {
    string plan = 1 [(Ydb.length).le = 102400];
    repeated Ydb.Issue.IssueMessage issues = 2;
    OperationStatistics statistics = 3;
    int32 result_set_count = 4 [(Ydb.value) = ">= 0"];
}

message ExecuteOperationRequest {
    Ydb.Operations.OperationParams operation_params = 1;
    Query query = 2;
    ExecuteMode mode = 3;
    string idempotency_key = 4 [(Ydb.length).le = 1024];
}

message ExecuteOperationResponse {
    Ydb.Operations.Operation operation = 1; // ExecuteOperationResult
}

message ExecuteOperationResult {
    string operation_id = 1 [(Ydb.length).le = 1024];
}

message ListOperationsRequest {
    Ydb.Operations.OperationParams operation_params = 1;
    string cloud_id = 2 [(Ydb.length).le = 1024];
    string folder_id = 3 [(Ydb.length).range = {min: 1, max: 1024}];
    string next_page_token = 4 [(Ydb.length).le = 1024];
    int32 limit = 5 [(Ydb.value) = "[0; 100]"];

    message Filter {
        repeated OperationMeta.ComputeState statuses = 1 [(Ydb.size).le = 20];
        repeated OperationAction actions = 2 [(Ydb.size).le = 20];
        repeated ExecuteMode modes = 3 [(Ydb.size).le = 20];
        string name = 4 [(Ydb.length).le = 1024];
    }
    Filter filter = 6;
}

message ListOperationsResponse {
    Ydb.Operations.Operation operation = 1; // ListOperationsResult
}

message ListOperationsResult {
    repeated OperationInfo operations = 1;
    string next_page_token = 2 [(Ydb.length).le = 1024];
}

message DescribeOperationRequest {
    Ydb.Operations.OperationParams operation_params = 1;
    string cloud_id = 2 [(Ydb.length).le = 1024];
    string folder_id = 3 [(Ydb.length).range = {min: 1, max: 1024}];
    string operation_id = 4 [(Ydb.length).range = {min: 1, max: 1024}];
}

message DescribeOperationResponse {
    Ydb.Operations.Operation operation = 1; // DescribeOperationResult
}

message DescribeOperationResult {
    OperationEntry operation = 1;
}

message DescribeOperationResultRequest {
    Ydb.Operations.OperationParams operation_params = 1;
    string cloud_id = 2 [(Ydb.length).le = 1024];
    string folder_id = 3 [(Ydb.length).range = {min: 1, max: 1024}];
    string operation_id = 4 [(Ydb.length).range = {min: 1, max: 1024}];
}

message DescribeOperationResultResponse {
    Ydb.Operations.Operation operation = 1; // DescribeOperationResultResult
}

message DescribeOperationResultResult {
    OperationResult result = 1;
}

message DeleteOperationRequest {
    Ydb.Operations.OperationParams operation_params = 1;
    string cloud_id = 2 [(Ydb.length).le = 1024];
    string folder_id = 3 [(Ydb.length).range = {min: 1, max: 1024}];
    string operation_id = 4 [(Ydb.length).range = {min: 1, max: 1024}];
    int64 previous_revision = 5 [(Ydb.value) = ">= 0"];
    string idempotency_key = 6 [(Ydb.length).le = 1024];
}

message DeleteOperationResponse {
    Ydb.Operations.Operation operation = 1; // DeleteOperationResult
}

message DeleteOperationResult {
}

message ModifyOperationRequest {
    Ydb.Operations.OperationParams operation_params = 1;
    string cloud_id = 2 [(Ydb.length).le = 1024];
    string folder_id = 3 [(Ydb.length).range = {min: 1, max: 1024}];
    string operation_id = 4 [(Ydb.length).range = {min: 1, max: 1024}];
    Acl acl = 5;
    Limits limits = 6;
    string name = 7 [(Ydb.length).le = 1024];
    int64 previous_revision = 8 [(Ydb.value) = ">= 0"];
    string idempotency_key = 9 [(Ydb.length).le = 1024];
}

message ModifyOperationResponse {
    Ydb.Operations.Operation operation = 1; // ModifyOperationResult
}

message ModifyOperationResult {
}

message ManageOperationRequest {
    Ydb.Operations.OperationParams operation_params = 1;
    string cloud_id = 2 [(Ydb.length).le = 1024];
    string folder_id = 3 [(Ydb.length).range = {min: 1, max: 1024}];
    string operation_id = 4 [(Ydb.length).range = {min: 1, max: 1024}];
    OperationAction action = 5;
    int64 previous_revision = 6 [(Ydb.value) = ">= 0"];
    string idempotency_key = 7 [(Ydb.length).le = 1024];
}

message ManageOperationResponse {
    Ydb.Operations.Operation operation = 1; // ManageOperationResult
}

message ManageOperationResult {
}

// Connection API

message CurrentIAMTokenAuth {
}

message ServiceAccountAuth {
    string id = 1 [(Ydb.length).le = 1024];
}

message Auth {
    oneof auth {
        CurrentIAMTokenAuth current_iam = 1;
        ServiceAccountAuth service_account = 2;
    }
}

message DataStreams {
    string endpoint = 1 [(Ydb.length).le = 1024];
    string database = 2 [(Ydb.length).le = 1024];
    string database_id = 3 [(Ydb.length).le = 1024];
    bool secure = 4;
    Auth auth = 5;
}

message YdbDatabase {
    string endpoint = 1 [(Ydb.length).le = 1024];
    string database = 2 [(Ydb.length).le = 1024];
    string database_id = 3 [(Ydb.length).le = 1024];
    bool secure = 4;
}

message ClickHouseCluster {
   string database_id = 1 [(Ydb.length).le = 1024];
   string host = 2 [(Ydb.length).le = 1024];
   int32 port = 3 [(Ydb.value) = "[0; 65536]"];
   bool secure = 4;
   string login = 5 [(Ydb.length).le = 1024];
   string password = 6 [(Ydb.length).le = 1024];
}

message ObjectStorageConnection {
    string bucket = 1 [(Ydb.length).le = 1024];
    Auth auth = 2;
}

message ConnectionSetting {
    oneof connection {
        YdbDatabase ydb_database = 1;
        ClickHouseCluster clickhouse_cluster = 2;
        DataStreams data_streams = 3;
        ObjectStorageConnection object_storage = 4;
    }
}

message Connection {
    string cloud_id = 1 [(Ydb.length).le = 1024];
    string folder_id = 2 [(Ydb.length).range = {min: 1, max: 1024}];
    string name = 3 [(Ydb.length).range = {min: 1, max: 1024}];
    ConnectionSetting setting = 4;
    Acl acl = 5;
}

message ConnectionEntry {
    Connection connection = 1;
    CommonMeta meta = 2;
}

message CreateConnectionRequest {
    Ydb.Operations.OperationParams operation_params = 1;
    Connection connection = 4;
    string idempotency_key = 5 [(Ydb.length).le = 1024];
}

message CreateConnectionResponse {
    Ydb.Operations.Operation operation = 1; // CreateConnectionResult
}

message CreateConnectionResult {
    string connection_id = 1 [(Ydb.length).range = {min: 1, max: 1024}];
}

message ListConnectionsRequest {
    Ydb.Operations.OperationParams operation_params = 1;
    string cloud_id = 2 [(Ydb.length).le = 1024];
    string folder_id = 3 [(Ydb.length).range = {min: 1, max: 1024}];
    string next_page_token = 4 [(Ydb.length).le = 1024];
    int32 limit = 5 [(Ydb.value) = "[0; 100]"];
}

message ListConnectionsResponse {
    Ydb.Operations.Operation operation = 1; // ListConnectionsResult
}

message ListConnectionsResult {
    repeated ConnectionEntry connections = 1;
    string next_page_token = 2 [(Ydb.length).le = 1024];
}

message DescribeConnectionRequest {
    Ydb.Operations.OperationParams operation_params = 1;
    string cloud_id = 2 [(Ydb.length).le = 1024];
    string folder_id = 3 [(Ydb.length).range = {min: 1, max: 1024}];
    string connection_id = 4 [(Ydb.length).range = {min: 1, max: 1024}];
}

message DescribeConnectionResponse {
    Ydb.Operations.Operation operation = 1; // DescribeConnectionResult
}

message DescribeConnectionResult {
    ConnectionEntry connection = 1;
}

message ModifyConnectionRequest {
    Ydb.Operations.OperationParams operation_params = 1;
    string connection_id = 4 [(Ydb.length).range = {min: 1, max: 1024}];
    Connection connection = 5;
    int64 previous_revision = 6 [(Ydb.value) = ">= 0"];
    string idempotency_key = 7 [(Ydb.length).le = 1024];
}

message ModifyConnectionResponse {
    Ydb.Operations.Operation operation = 1; // ModifyConnectionResult
}

message ModifyConnectionResult {
}

message DeleteConnectionRequest {
    Ydb.Operations.OperationParams operation_params = 1;
    string cloud_id = 2 [(Ydb.length).le = 1024];
    string folder_id = 3 [(Ydb.length).range = {min: 1, max: 1024}];
    string connection_id = 4 [(Ydb.length).range = {min: 1, max: 1024}];
    int64 previous_revision = 5 [(Ydb.value) = ">= 0"];
    string idempotency_key = 6 [(Ydb.length).le = 1024];
}

message DeleteConnectionResponse {
    Ydb.Operations.Operation operation = 1; // DeleteConnectionResult
}

message DeleteConnectionResult {
}

// ResultSet API

message GetResultDataRequest {
    Ydb.Operations.OperationParams operation_params = 1;
    string cloud_id = 2 [(Ydb.length).le = 1024];
    string folder_id = 3 [(Ydb.length).range = {min: 1, max: 1024}];
    string operation_id = 4 [(Ydb.length).range = {min: 1, max: 1024}];
    int32 result_set_index = 5 [(Ydb.value) = ">= 0"];
    string next_page_token = 6 [(Ydb.length).le = 1024];
    int32 limit = 7 [(Ydb.value) = "[0; 100]"];
}

message GetResultDataResponse {
    Ydb.Operations.Operation operation = 1; // GetResultDataResult
}

message GetResultDataResult {
    Ydb.ResultSet result_set = 1;
}

// Binding API

message Schema {
    repeated Ydb.Column columns = 1 [(Ydb.size).le = 100];
}

message DataStreamsBinding {
    string stream_name = 1 [(Ydb.length).range = {min: 1, max: 1024}];
    string format = 2 [(Ydb.length).le = 1024];
    string compression = 3 [(Ydb.length).le = 1024];
    Schema schema = 4;
}

message ObjectStorageBinding {
    message Subset {
        string path_pattern = 1 [(Ydb.length).range = {min: 1, max: 1024}];
        string format = 2 [(Ydb.length).le = 1024];
        repeated StringsPair format_settings = 3 [(Ydb.size).le = 100];
        string compression = 4 [(Ydb.length).le = 1024];
        Schema schema = 5;
    }

    repeated Subset subsets = 1;
}

message BindingSetting {
    oneof binding {
        DataStreamsBinding data_streams = 1;
        ObjectStorageBinding object_storage = 2;
    }
}

message Binding {
    string cloud_id = 1 [(Ydb.length).le = 1024];
    string folder_id = 2 [(Ydb.length).range = {min: 1, max: 1024}];
    string name = 3 [(Ydb.length).range = {min: 1, max: 1024}];
    string connection_id = 4 [(Ydb.length).range = {min: 1, max: 1024}];
    BindingSetting setting = 5;
}

message BindingEntry {
    Binding binding = 1;
    CommonMeta meta = 2;
}

message CreateBindingRequest {
    Ydb.Operations.OperationParams operation_params = 1;
    Binding binding = 4;
    string idempotency_key = 5 [(Ydb.length).le = 1024];
}

message CreateBindingResponse {
    Ydb.Operations.Operation operation = 1; // CreateBindingResult
}

message CreateBindingResult {
    string binding_id = 1 [(Ydb.length).range = {min: 1, max: 1024}];
}

message ListBindingsRequest {
    Ydb.Operations.OperationParams operation_params = 1;
    string cloud_id = 2 [(Ydb.length).le = 1024];
    string folder_id = 3 [(Ydb.length).range = {min: 1, max: 1024}];
    string next_page_token = 4 [(Ydb.length).le = 1024];
    int32 limit = 5 [(Ydb.value) = "[0; 100]"];
}

message ListBindingsResponse {
    Ydb.Operations.Operation operation = 1; // ListBindingsResult
}

message ListBindingsResult {
    repeated BindingEntry bindings = 1;
    string next_page_token = 2 [(Ydb.length).le = 1024];
}

message DescribeBindingRequest {
    Ydb.Operations.OperationParams operation_params = 1;
    string cloud_id = 2 [(Ydb.length).le = 1024];
    string folder_id = 3 [(Ydb.length).range = {min: 1, max: 1024}];
    string binding_id = 4 [(Ydb.length).range = {min: 1, max: 1024}];
}

message DescribeBindingResponse {
    Ydb.Operations.Operation operation = 1; // DescribeBindingResult
}

message DescribeBindingResult {
    BindingEntry binding = 1;
}

message ModifyBindingRequest {
    Ydb.Operations.OperationParams operation_params = 1;
    string binding_id = 4 [(Ydb.length).range = {min: 1, max: 1024}];
    Binding binding = 5;
    int64 previous_revision = 6 [(Ydb.value) = ">= 0"];
    string idempotency_key = 7 [(Ydb.length).le = 1024];
}

message ModifyBindingResponse {
    Ydb.Operations.Operation operation = 1; // ModifyBindingResult
}

message ModifyBindingResult {
}

message DeleteBindingRequest {
    Ydb.Operations.OperationParams operation_params = 1;
    string cloud_id = 2 [(Ydb.length).le = 1024];
    string folder_id = 3 [(Ydb.length).range = {min: 1, max: 1024}];
    string binding_id = 4 [(Ydb.length).range = {min: 1, max: 1024}];
    int64 previous_revision = 5 [(Ydb.value) = ">= 0"];
    string idempotency_key = 6 [(Ydb.length).le = 1024];
}

message DeleteBindingResponse {
    Ydb.Operations.Operation operation = 1; // DeleteBindingResult
}

message DeleteBindingResult {
}